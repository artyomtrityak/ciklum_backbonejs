define(["./collection","./view"],function(e,t){return Backbone.View.extend({el:$("#ciklumers-list-container"),list_el:$("#ciklumers-list-container-list"),end_reached:!1,events:{scroll:"lazy_loader","click #ciklumers-list-container-list-load-more > a":"manual_load_more"},initialize:function(){this.set_list_height(),this.collection=new e},manual_load_more:function(){return this.get_next_page(),!1},get_next_page:function(e){if(this.end_reached===!0||this.collection.is_loading()===!0)return;this.collection.set_options(e),this.collection.set_loading(!0),this.collection.fetch({add:!0,wait:!0,data:this.collection.get_options(),success:_.bind(this.render,this),error:_.bind(this.error,this)})},render:function(e){e=_.extend({add_new:!1},e),this.collection.set_loading(!1);var n=$("<div />"),r=this.collection.where({rendered:!1});if(r.length===0){this.end_reached=!0;return}_.each(r,function(e){n.append((new t({model:e,parent:this})).render().$el)},this),e.add_new===!0?this.list_el.prepend(n):(this.list_el.append(n),this.collection.incr_page())},reset:function(){this.end_reached=!1,this.collection.reset_data(),this.list_el.html("")},error:function(){this.collection.set_loading(!1)},add_user:function(e){this.collection.add(e),this.render({add_new:!0})},lazy_loader:function(){var e=this.$el.get(0).scrollHeight-this.$el.scrollTop();e<this.$el.height()+400&&this.get_next_page()},set_list_height:function(){var e=$(window).height()-160;this.$el.height(e)}})})